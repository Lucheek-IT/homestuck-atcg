---
import SiteLayout from "../layouts/SiteLayout.astro";
import CardRow from "../components/CardRow.astro";
import { readFileSync } from 'node:fs';
import { parse } from 'csv-parse/sync';

const cardCsv = readFileSync('./src/cards/cards.csv', { encoding: 'utf-8' });
const cards = parse(cardCsv, {
    columns: true,
    skip_empty_lines: true
});

const cardArt = await Astro.glob('../cards/images/*.png');

/** When building for real, the filenames will contain a cache-buster segment, e.g. Set1_Chara001.3c3d8a15.png */
const cacheBusterExtractor = /(\..*)\./;
const fileNameExtractor = /\/([^\/]*\.png)/;

const artCollection = Object.fromEntries(cardArt.map((art) => {
    const imageName = art.default.src.match(fileNameExtractor)[1].replace(cacheBusterExtractor, '.');

    return [imageName, art.default];
}));
---
<SiteLayout title="Card Database" wide=true>
    <h1 class="sr-only">Cards</h1>
    <div class="overflow-x-auto">
        <table id="cards" class="text-sm">
            <thead>
            <tr>
                <th scope="col">Title</th>
                <th scope="col">Subtitle</th>
                <th scope="col" data-type="number">Base Power</th>
                <th scope="col" data-hidden="true">Draw Boost</th>
                <th scope="col" data-hidden="true">Max Damage</th>
                <th scope="col" data-type="number">Stars</th>
                <th scope="col" data-hidden="true">Game Text</th>
                <th scope="col" data-hidden="true">Flavorlogue</th>
                <th scope="col">Art Credit</th>
                <th scope="col">Pictures</th>
                <th scope="col" data-hidden="true">Set Release</th>
                <th scope="col" data-hidden="true">Card Number</th>
            </tr>
            </thead>
            <tbody>
                { cards.map((card) => <CardRow card={card} artCollection={artCollection} />) }
            </tbody>
        </table>
    </div>
</SiteLayout>

<script>
    import { DataTable, addColumnFilter } from "simple-datatables";

    const dt = new DataTable('#cards', {
        paging: false,
    });

    addColumnFilter(dt);

    document.querySelector('.datatable-search .datatable-input').setAttribute('aria-label', 'Search');
    document.querySelector('nav.datatable-pagination').setAttribute('aria-label', 'Card Page');
</script>